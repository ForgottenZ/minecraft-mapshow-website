{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>地图标签管理：{{ map_name }}</h2>
  <form method="post" class="tag-form">
    <div class="tag-actions">
      <button type="submit" class="button primary">保存标签</button>
    </div>
    <div class="default-tags">
      <span class="hint">默认标签快捷按钮：</span>
      {% for tag in default_tags %}
        <button type="button" class="button small" data-tag="{{ tag.id }}">{{ tag.name }}</button>
      {% else %}
        <span class="hint">暂无默认标签</span>
      {% endfor %}
    </div>
    <div class="checkbox-grid">
      {% for tag in tags %}
        <label class="checkbox">
          <input type="checkbox" name="tags" value="{{ tag.id }}" {% if tag.id in current_ids %}checked{% endif %} />
          {{ tag.name }}
        </label>
      {% endfor %}
    </div>
  </form>
</section>

<section class="card iframe-card">
  <h3>创建新标签（可拖动窗口）</h3>
  <div class="iframe-container" id="tag-iframe">
    <div class="iframe-header" id="iframe-handle">
      创建标签
      <span class="iframe-tip">拖动这里移动窗口</span>
    </div>
    <iframe src="{{ url_for('admin_tags_new') }}" title="创建标签"></iframe>
  </div>
</section>

<script>
  const defaultButtons = document.querySelectorAll('[data-tag]');
  defaultButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const tagId = button.getAttribute('data-tag');
      const checkbox = document.querySelector(`input[name="tags"][value="${tagId}"]`);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    });
  });

  const iframeBox = document.getElementById('tag-iframe');
  const handle = document.getElementById('iframe-handle');
  let offsetX = 0;
  let offsetY = 0;
  let dragging = false;

  handle.addEventListener('mousedown', (event) => {
    dragging = true;
    const rect = iframeBox.getBoundingClientRect();
    offsetX = event.clientX - rect.left;
    offsetY = event.clientY - rect.top;
    iframeBox.style.position = 'fixed';
  });

  document.addEventListener('mousemove', (event) => {
    if (!dragging) {
      return;
    }
    iframeBox.style.left = `${event.clientX - offsetX}px`;
    iframeBox.style.top = `${event.clientY - offsetY}px`;
  });

  document.addEventListener('mouseup', () => {
    dragging = false;
  });
</script>
{% endblock %}
